---
layout: default
section: Week6
title: 05-ç³»ç»Ÿæ¶æ„è®¾è®¡
---

# 05. ç³»ç»Ÿæ¶æ„è®¾è®¡ ğŸ°

> "ç£¨åˆ€ä¸è¯¯ç æŸ´å·¥" ~ å¤äººè¯šä¸æ¬ºæˆ‘

å‰å‡ èŠ‚è¯¾æˆ‘ä»¬å­¦ä¹ äº†å„ä¸ªç»„ä»¶ï¼Œç°åœ¨è¦æŠŠå®ƒä»¬**æ•´åˆæˆä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿ**ï¼

---

## ğŸ¨ æ¨¡å—åŒ–è®¾è®¡åŸåˆ™

### å•ä¸€èŒè´£åŸåˆ™ (Single Responsibility)

```python
# âŒ åçš„è®¾è®¡ - ä¸€ä¸ªç±»åšå¤ªå¤šäº‹
class BadSystem:
    def __init__(self):
        pass
    
    def fetch_data(self):
        pass
    
    def clean_data(self):
        pass
    
    def train_model(self):
        pass
    
    def save_model(self):
        pass
    
    def make_predictions(self):
        pass
    
    def execute_trades(self):
        pass
    
    def calculate_metrics(self):
        pass

# âœ… å¥½çš„è®¾è®¡ - æ¯ä¸ªç±»èŒè´£å•ä¸€
class DataFetcher:
    """æ•°æ®è·å–å™¨"""
    def fetch(self):
        pass

class DataCleaner:
    """æ•°æ®æ¸…æ´—å™¨"""
    def clean(self):
        pass

class ModelTrainer:
    """æ¨¡å‹è®­ç»ƒå™¨"""
    def train(self):
        pass

class ModelSaver:
    """æ¨¡å‹ä¿å­˜å™¨"""
    def save(self):
        pass

class Predictor:
    """é¢„æµ‹å™¨"""
    def predict(self):
        pass

class TradeExecutor:
    """äº¤æ˜“æ‰§è¡Œå™¨"""
    def execute(self):
        pass

class MetricsCalculator:
    """æŒ‡æ ‡è®¡ç®—å™¨"""
    def calculate(self):
        pass
```

### ä½è€¦åˆã€é«˜å†…èš

```python
# âœ… å¥½çš„è®¾è®¡ - ä½è€¦åˆ
class TradingSystem:
    def __init__(self, data_fetcher, model_trainer, trade_executor):
        """
        é€šè¿‡ä¾èµ–æ³¨å…¥ï¼Œå„ä¸ªæ¨¡å—ä¹‹é—´ä¸ç›´æ¥ä¾èµ–
        """
        self.data_fetcher = data_fetcher
        self.model_trainer = model_trainer
        self.trade_executor = trade_executor
    
    def run(self):
        # è°ƒç”¨å„ä¸ªæ¨¡å—çš„æ–¹æ³•
        data = self.data_fetcher.fetch()
        model = self.model_trainer.train(data)
        trades = self.trade_executor.execute(model)
        return trades

# ä½¿ç”¨æ—¶çµæ´»ç»„åˆ
system = TradingSystem(
    data_fetcher=DatabaseFetcher(),
    model_trainer=LightGBMTrainer(),
    trade_executor=BrokerExecutor()
)
```

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

### äº”å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å±•ç¤ºå±‚ (Presentation)                 â”‚
â”‚  - Webç•Œé¢  - APIæ¥å£  - ç›‘æ§é¢æ¿                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic)           â”‚
â”‚  - ç­–ç•¥ç®¡ç†  - é£é™©æ§åˆ¶  - æŠ•èµ„ç»„åˆç®¡ç†                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœåŠ¡å±‚ (Services)                     â”‚
â”‚  - æ•°æ®æœåŠ¡  - æ¨¡å‹æœåŠ¡  - äº¤æ˜“æœåŠ¡  - åˆ†ææœåŠ¡          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å±‚ (Data Layer)                   â”‚
â”‚  - æ•°æ®åº“  - æ¨¡å‹å­˜å‚¨  - é…ç½®æ–‡ä»¶  - æ—¥å¿—æ–‡ä»¶            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŸºç¡€è®¾æ–½å±‚ (Infrastructure)            â”‚
â”‚  - æœåŠ¡å™¨  - ç½‘ç»œ  - ç¼“å­˜  - æ¶ˆæ¯é˜Ÿåˆ—                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Œæ•´ç³»ç»Ÿæ¶æ„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  å¤–éƒ¨æ•°æ® â”‚
                    â”‚  æºAPI   â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   æ•°æ®é‡‡é›†æ¨¡å—       â”‚
              â”‚   (DataCollector)  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   æ•°æ®æ¸…æ´—æ¨¡å—       â”‚
              â”‚   (DataCleaner)   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   ç‰¹å¾å·¥ç¨‹æ¨¡å—       â”‚
              â”‚   (FeatureEngine) â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ¨¡å‹è®­ç»ƒæ¨¡å—     â”‚  â”‚  æ¨¡å‹æ¨ç†æ¨¡å—     â”‚
    â”‚  (ModelTrainer) â”‚  â”‚  (ModelPredictor)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“                     â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ¨¡å‹ç®¡ç†æ¨¡å—     â”‚  â”‚  é›†æˆç­–ç•¥æ¨¡å—     â”‚
    â”‚  (ModelManager)  â”‚  â”‚  (Ensemble)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“                     â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         æŠ•èµ„ç»„åˆæ„å»ºæ¨¡å—               â”‚
    â”‚      (PortfolioBuilder)             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   é£é™©æ§åˆ¶æ¨¡å—       â”‚
              â”‚   (RiskController) â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   äº¤æ˜“æ‰§è¡Œæ¨¡å—       â”‚
              â”‚   (TradeExecutor) â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   ç»©æ•ˆåˆ†ææ¨¡å—       â”‚
              â”‚  (PerformanceAnalyzer)â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   ç›‘æ§æŠ¥è­¦æ¨¡å—       â”‚
              â”‚   (Monitor)       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   æ—¥å¿—è®°å½•æ¨¡å—       â”‚
              â”‚   (Logger)        â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš™ï¸ é…ç½®é©±åŠ¨å¼€å‘

### ç³»ç»Ÿé…ç½®æ–‡ä»¶

```python
# config.py
import json
from typing import Dict, Any
from pathlib import Path

class SystemConfig:
    """ç³»ç»Ÿé…ç½®ç®¡ç†å™¨"""
    
    def __init__(self, config_file: str = 'config.json'):
        """
        åˆå§‹åŒ–é…ç½®
        
        Args:
            config_file: é…ç½®æ–‡ä»¶è·¯å¾„
        """
        self.config_file = config_file
        self.config = self._load_config()
    
    def _load_config(self) -> Dict[str, Any]:
        """åŠ è½½é…ç½®æ–‡ä»¶"""
        config_path = Path(self.config_file)
        
        if not config_path.exists():
            raise FileNotFoundError(f"é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {config_path}")
        
        with open(config_path, 'r', encoding='utf-8') as f:
            config = json.load(f)
        
        return config
    
    def get(self, key: str, default=None):
        """
        è·å–é…ç½®é¡¹
        
        Args:
            key: é…ç½®é”®ï¼ˆæ”¯æŒåµŒå¥—ï¼Œå¦‚ 'model.params.learning_rate'ï¼‰
            default: é»˜è®¤å€¼
            
        Returns:
            é…ç½®å€¼
        """
        keys = key.split('.')
        value = self.config
        
        for k in keys:
            if isinstance(value, dict):
                value = value.get(k)
            else:
                return default
            
            if value is None:
                return default
        
        return value
    
    def save(self, key: str, value: Any):
        """
        ä¿å­˜é…ç½®é¡¹
        
        Args:
            key: é…ç½®é”®
            value: é…ç½®å€¼
        """
        keys = key.split('.')
        config = self.config
        
        # éå†åˆ°å€’æ•°ç¬¬äºŒå±‚
        for k in keys[:-1]:
            if k not in config:
                config[k] = {}
            config = config[k]
        
        # è®¾ç½®æœ€åä¸€å±‚
        config[keys[-1]] = value
        
        # ä¿å­˜åˆ°æ–‡ä»¶
        with open(self.config_file, 'w', encoding='utf-8') as f:
            json.dump(self.config, f, indent=2, ensure_ascii=False)
    
    def reload(self):
        """é‡æ–°åŠ è½½é…ç½®"""
        self.config = self._load_config()
```

### é…ç½®æ–‡ä»¶ç¤ºä¾‹

```json
{
  "system": {
    "name": "QuantTradingSystem",
    "version": "1.0.0",
    "environment": "production",
    "timezone": "Asia/Shanghai"
  },
  "data": {
    "source": "database",
    "database": {
      "host": "localhost",
      "port": 5432,
      "name": "quant_db",
      "user": "quant_user",
      "password": "********"
    },
    "cache": {
      "enabled": true,
      "ttl": 3600
    }
  },
  "model": {
    "type": "LightGBM",
    "params": {
      "objective": "regression",
      "metric": "rmse",
      "learning_rate": 0.05,
      "num_leaves": 31,
      "feature_fraction": 0.9,
      "bagging_fraction": 0.8
    },
    "retrain": {
      "enabled": true,
      "frequency": "monthly",
      "window_size": 365
    }
  },
  "risk": {
    "max_position": 0.10,
    "max_total_position": 0.95,
    "stop_loss": {
      "enabled": true,
      "type": "trailing",
      "percent": 0.10
    }
  },
  "trading": {
    "executor": "broker",
    "broker": {
      "name": "simulated",
      "commission": 0.001,
      "slippage": 0.0001
    }
  },
  "monitoring": {
    "enabled": true,
    "metrics": ["IC", "RankIC", "Return", "Drawdown"],
    "alerts": {
      "drawdown_threshold": 0.10,
      "ic_threshold": 0.02
    }
  }
}
```

### ä½¿ç”¨é…ç½®

```python
# åˆå§‹åŒ–é…ç½®
config = SystemConfig('config.json')

# è·å–é…ç½®
model_type = config.get('model.type')
learning_rate = config.get('model.params.learning_rate')
max_position = config.get('risk.max_position')

print(f"æ¨¡å‹ç±»å‹: {model_type}")
print(f"å­¦ä¹ ç‡: {learning_rate}")
print(f"æœ€å¤§ä»“ä½: {max_position}")
```

---

## ğŸ§µ çº¿ç¨‹ç®¡ç†

### æ¨¡å‹ç‰ˆæœ¬æ§åˆ¶

```python
import os
from datetime import datetime
from typing import Optional, List
import pickle

class ModelVersionControl:
    """æ¨¡å‹ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ"""
    
    def __init__(self, model_dir: str = './models'):
        """
        åˆå§‹åŒ–
        
        Args:
            model_dir: æ¨¡å‹å­˜å‚¨ç›®å½•
        """
        self.model_dir = model_dir
        os.makedirs(model_dir, exist_ok=True)
        self.version_file = os.path.join(model_dir, 'versions.json')
        self.versions = self._load_versions()
    
    def _load_versions(self) -> dict:
        """åŠ è½½ç‰ˆæœ¬ä¿¡æ¯"""
        if not os.path.exists(self.version_file):
            return {}
        
        with open(self.version_file, 'r', encoding='utf-8') as f:
            import json
            return json.load(f)
    
    def _save_versions(self):
        """ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯"""
        import json
        with open(self.version_file, 'w', encoding='utf-8') as f:
            json.dump(self.versions, f, indent=2, ensure_ascii=False)
    
    def register_model(self, model, model_name: str, metadata: Optional[dict] = None) -> str:
        """
        æ³¨å†Œæ–°æ¨¡å‹
        
        Args:
            model: æ¨¡å‹å¯¹è±¡
            model_name: æ¨¡å‹åç§°
            metadata: å…ƒæ•°æ®
            
        Returns:
            ç‰ˆæœ¬å·
        """
        # ç”Ÿæˆç‰ˆæœ¬å·
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        version_id = f"{model_name}_{timestamp}"
        
        # ä¿å­˜æ¨¡å‹
        model_file = os.path.join(self.model_dir, f"{version_id}.pkl")
        with open(model_file, 'wb') as f:
            pickle.dump(model, f)
        
        # è®°å½•ç‰ˆæœ¬ä¿¡æ¯
        if model_name not in self.versions:
            self.versions[model_name] = []
        
        self.versions[model_name].append({
            'version_id': version_id,
            'timestamp': timestamp,
            'file': model_file,
            'metadata': metadata or {}
        })
        
        self._save_versions()
        
        print(f"âœ… æ¨¡å‹å·²æ³¨å†Œ: {version_id}")
        return version_id
    
    def get_latest_model(self, model_name: str):
        """
        è·å–æœ€æ–°ç‰ˆæœ¬
        
        Args:
            model_name: æ¨¡å‹åç§°
            
        Returns:
            æ¨¡å‹å’Œå…ƒæ•°æ®
        """
        if model_name not in self.versions:
            raise ValueError(f"æ¨¡å‹ä¸å­˜åœ¨: {model_name}")
        
        versions = self.versions[model_name]
        latest = versions[-1]
        
        # åŠ è½½æ¨¡å‹
        with open(latest['file'], 'rb') as f:
            model = pickle.load(f)
        
        return model, latest
    
    def get_model_by_version(self, version_id: str):
        """
        æ ¹æ®ç‰ˆæœ¬å·è·å–æ¨¡å‹
        
        Args:
            version_id: ç‰ˆæœ¬å·
            
        Returns:
            æ¨¡å‹å’Œå…ƒæ•°æ®
        """
        for model_name, versions in self.versions.items():
            for version in versions:
                if version['version_id'] == version_id:
                    # åŠ è½½æ¨¡å‹
                    with open(version['file'], 'rb') as f:
                        model = pickle.load(f)
                    
                    return model, version
        
        raise ValueError(f"ç‰ˆæœ¬ä¸å­˜åœ¨: {version_id}")
    
    def list_versions(self, model_name: str = None) -> List[dict]:
        """
        åˆ—å‡ºç‰ˆæœ¬
        
        Args:
            model_name: æ¨¡å‹åç§°ï¼ˆå¯é€‰ï¼‰
            
        Returns:
            ç‰ˆæœ¬åˆ—è¡¨
        """
        if model_name:
            if model_name not in self.versions:
                return []
            return self.versions[model_name]
        else:
            return self.versions
    
    def rollback(self, model_name: str, n_versions: int = 1):
        """
        å›æ»šåˆ°å‰nä¸ªç‰ˆæœ¬
        
        Args:
            model_name: æ¨¡å‹åç§°
            n_versions: å›æ»šçš„ç‰ˆæœ¬æ•°
        """
        if model_name not in self.versions:
            raise ValueError(f"æ¨¡å‹ä¸å­˜åœ¨: {model_name}")
        
        versions = self.versions[model_name]
        
        if len(versions) <= n_versions:
            raise ValueError(f"ç‰ˆæœ¬ä¸è¶³ï¼Œæ— æ³•å›æ»š {n_versions} ä¸ªç‰ˆæœ¬")
        
        # åˆ é™¤æœ€æ–°çš„nä¸ªç‰ˆæœ¬
        for _ in range(n_versions):
            version = versions.pop()
            
            # åˆ é™¤æ¨¡å‹æ–‡ä»¶
            if os.path.exists(version['file']):
                os.remove(version['file'])
        
        self._save_versions()
        
        print(f"âœ… å·²å›æ»š {n_versions} ä¸ªç‰ˆæœ¬")
```

### æ•°æ®æµç®¡ç†

```python
from queue import Queue
from threading import Thread, Lock
import time

class DataPipeline:
    """æ•°æ®æµæ°´çº¿"""
    
    def __init__(self, n_workers: int = 4):
        """
        åˆå§‹åŒ–æ•°æ®æµæ°´çº¿
        
        Args:
            n_workers: å·¥ä½œçº¿ç¨‹æ•°
        """
        self.n_workers = n_workers
        self.input_queue = Queue(maxsize=1000)
        self.output_queue = Queue(maxsize=1000)
        self.lock = Lock()
        self.workers = []
        self.running = False
        
    def start(self):
        """å¯åŠ¨æµæ°´çº¿"""
        self.running = True
        
        # åˆ›å»ºå·¥ä½œçº¿ç¨‹
        for i in range(self.n_workers):
            worker = Thread(target=self._worker, args=(i,))
            worker.start()
            self.workers.append(worker)
        
        print(f"âœ… æ•°æ®æµæ°´çº¿å·²å¯åŠ¨ ({self.n_workers} ä¸ªå·¥ä½œçº¿ç¨‹)")
    
    def stop(self):
        """åœæ­¢æµæ°´çº¿"""
        self.running = False
        
        # ç­‰å¾…æ‰€æœ‰å·¥ä½œçº¿ç¨‹ç»“æŸ
        for worker in self.workers:
            worker.join()
        
        print("âœ… æ•°æ®æµæ°´çº¿å·²åœæ­¢")
    
    def _worker(self, worker_id: int):
        """å·¥ä½œçº¿ç¨‹"""
        print(f"  å·¥ä½œçº¿ç¨‹ {worker_id} å¯åŠ¨")
        
        while self.running:
            try:
                # ä»è¾“å…¥é˜Ÿåˆ—è·å–ä»»åŠ¡
                task = self.input_queue.get(timeout=1)
                
                # å¤„ç†ä»»åŠ¡
                result = self._process_task(task)
                
                # å°†ç»“æœæ”¾å…¥è¾“å‡ºé˜Ÿåˆ—
                self.output_queue.put(result)
                
                # æ ‡è®°ä»»åŠ¡å®Œæˆ
                self.input_queue.task_done()
                
            except:
                continue
        
        print(f"  å·¥ä½œçº¿ç¨‹ {worker_id} åœæ­¢")
    
    def _process_task(self, task: dict):
        """å¤„ç†ä»»åŠ¡ï¼ˆéœ€è¦å­ç±»å®ç°ï¼‰"""
        raise NotImplementedError("éœ€è¦å­ç±»å®ç°")
    
    def add_task(self, task: dict):
        """æ·»åŠ ä»»åŠ¡"""
        self.input_queue.put(task)
    
    def get_result(self, timeout: float = 1.0):
        """è·å–ç»“æœ"""
        return self.output_queue.get(timeout=timeout)
```

---

## ğŸ° å®Œæ•´ç³»ç»Ÿå®ç°

### ä¸»ç³»ç»Ÿç±»

```python
import logging
from typing import Dict, Any
from datetime import datetime

class QuantTradingSystem:
    """é‡åŒ–äº¤æ˜“ä¸»ç³»ç»Ÿ"""
    
    def __init__(self, config: SystemConfig):
        """
        åˆå§‹åŒ–ç³»ç»Ÿ
        
        Args:
            config: ç³»ç»Ÿé…ç½®
        """
        self.config = config
        self.logger = self._setup_logger()
        self.components = {}
        
        # åˆå§‹åŒ–å„ä¸ªç»„ä»¶
        self._init_components()
        
    def _setup_logger(self) -> logging.Logger:
        """è®¾ç½®æ—¥å¿—"""
        logger = logging.getLogger('QuantTradingSystem')
        logger.setLevel(logging.INFO)
        
        # æ–‡ä»¶å¤„ç†å™¨
        file_handler = logging.FileHandler('trading_system.log')
        file_handler.setLevel(logging.INFO)
        
        # æ§åˆ¶å°å¤„ç†å™¨
        console_handler = logging.StreamHandler()
        console_handler.setLevel(logging.INFO)
        
        # æ ¼å¼åŒ–å™¨
        formatter = logging.Formatter(
            '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
        )
        file_handler.setFormatter(formatter)
        console_handler.setFormatter(formatter)
        
        logger.addHandler(file_handler)
        logger.addHandler(console_handler)
        
        return logger
    
    def _init_components(self):
        """åˆå§‹åŒ–ç»„ä»¶"""
        self.logger.info("æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿç»„ä»¶...")
        
        # æ•°æ®é‡‡é›†å™¨
        self.components['data_collector'] = DataCollector(
            source=self.config.get('data.source')
        )
        
        # ç‰¹å¾å·¥ç¨‹
        self.components['feature_engine'] = FeatureEngine(
            config=self.config.get('feature')
        )
        
        # æ¨¡å‹è®­ç»ƒå™¨
        self.components['model_trainer'] = ModelTrainer(
            params=self.config.get('model.params')
        )
        
        # æ¨¡å‹ç®¡ç†å™¨
        self.components['model_manager'] = ModelManager(
            model_dir=self.config.get('model.model_dir', './models')
        )
        
        # é£é™©æ§åˆ¶å™¨
        self.components['risk_controller'] = RiskController(
            max_position=self.config.get('risk.max_position'),
            max_total_position=self.config.get('risk.max_total_position')
        )
        
        # äº¤æ˜“æ‰§è¡Œå™¨
        self.components['trade_executor'] = TradeExecutor(
            broker_config=self.config.get('trading.broker')
        )
        
        # ç»©æ•ˆåˆ†æå™¨
        self.components['performance_analyzer'] = PerformanceAnalyzer()
        
        # ç›‘æ§å™¨
        self.components['monitor'] = Monitor(
            config=self.config.get('monitoring')
        )
        
        self.logger.info("âœ… ç³»ç»Ÿç»„ä»¶åˆå§‹åŒ–å®Œæˆ")
    
    def train_model(self, data: pd.DataFrame):
        """
        è®­ç»ƒæ¨¡å‹
        
        Args:
            data: è®­ç»ƒæ•°æ®
        """
        self.logger.info("å¼€å§‹è®­ç»ƒæ¨¡å‹...")
        
        # ç‰¹å¾å·¥ç¨‹
        features = self.components['feature_engine'].extract_features(data)
        
        # è®­ç»ƒæ¨¡å‹
        model = self.components['model_trainer'].train(features)
        
        # ä¿å­˜æ¨¡å‹
        model_id = self.components['model_manager'].save_model(
            model=model,
            metadata={'timestamp': datetime.now().isoformat()}
        )
        
        self.logger.info(f"âœ… æ¨¡å‹è®­ç»ƒå®Œæˆ: {model_id}")
        
        return model_id
    
    def run_strategy(self, date: str):
        """
        è¿è¡Œç­–ç•¥
        
        Args:
            date: äº¤æ˜“æ—¥æœŸ
        """
        self.logger.info(f"è¿è¡Œç­–ç•¥: {date}")
        
        # 1. è·å–æ•°æ®
        data = self.components['data_collector'].fetch(date)
        
        # 2. ç‰¹å¾å·¥ç¨‹
        features = self.components['feature_engine'].extract_features(data)
        
        # 3. æ¨¡å‹é¢„æµ‹
        model, _ = self.components['model_manager'].get_latest_model()
        predictions = model.predict(features)
        
        # 4. æŠ•èµ„ç»„åˆæ„å»º
        portfolio = self._build_portfolio(predictions)
        
        # 5. é£é™©æ§åˆ¶
        portfolio = self.components['risk_controller'].apply_risk_control(portfolio)
        
        # 6. æ‰§è¡Œäº¤æ˜“
        trades = self.components['trade_executor'].execute(portfolio)
        
        # 7. è®°å½•æ—¥å¿—
        self._log_trades(date, trades)
        
        # 8. ç»©æ•ˆåˆ†æ
        self.components['performance_analyzer'].analyze(date, trades)
        
        # 9. ç›‘æ§æ£€æŸ¥
        self.components['monitor'].check(date)
        
        self.logger.info(f"âœ… ç­–ç•¥è¿è¡Œå®Œæˆ: {date}")
        
        return trades
    
    def _build_portfolio(self, predictions: pd.Series) -> Dict[str, float]:
        """
        æ„å»ºæŠ•èµ„ç»„åˆ
        
        Args:
            predictions: é¢„æµ‹åˆ†æ•°
            
        Returns:
            æŠ•èµ„ç»„åˆæƒé‡
        """
        # æ ¹æ®é¢„æµ‹åˆ†æ•°åˆ†é…æƒé‡
        weights = predictions / predictions.sum()
        
        # é™åˆ¶å•ä¸ªè‚¡ç¥¨æœ€å¤§æƒé‡
        max_position = self.config.get('risk.max_position', 0.10)
        weights = weights.clip(upper=max_position)
        
        # é‡æ–°å½’ä¸€åŒ–
        weights = weights / weights.sum()
        
        return dict(weights)
    
    def _log_trades(self, date: str, trades: list):
        """
        è®°å½•äº¤æ˜“
        
        Args:
            date: äº¤æ˜“æ—¥æœŸ
            trades: äº¤æ˜“åˆ—è¡¨
        """
        # è®°å½•åˆ°æ—¥å¿—
        self.logger.info(f"äº¤æ˜“è®°å½•: {date}")
        for trade in trades:
            self.logger.info(f"  {trade}")
    
    def start(self):
        """å¯åŠ¨ç³»ç»Ÿ"""
        self.logger.info("ğŸš€ å¯åŠ¨é‡åŒ–äº¤æ˜“ç³»ç»Ÿ...")
        
        # å¯åŠ¨ç›‘æ§
        if self.config.get('monitoring.enabled', True):
            self.components['monitor'].start()
        
        self.logger.info("âœ… ç³»ç»Ÿå·²å¯åŠ¨")
    
    def stop(self):
        """åœæ­¢ç³»ç»Ÿ"""
        self.logger.info("ğŸ›‘ åœæ­¢é‡åŒ–äº¤æ˜“ç³»ç»Ÿ...")
        
        # åœæ­¢ç›‘æ§
        if 'monitor' in self.components:
            self.components['monitor'].stop()
        
        self.logger.info("âœ… ç³»ç»Ÿå·²åœæ­¢")
```

---

## ğŸ“ æœ¬èŠ‚å°ç»“

**æ ¸å¿ƒè¦ç‚¹**ï¼š

1. âœ… æ¨¡å—åŒ–è®¾è®¡ä½¿ç³»ç»Ÿæ˜“äºç»´æŠ¤
2. âœ… äº”å±‚æ¶æ„æ¸…æ™°åˆ’åˆ†èŒè´£
3. âœ… é…ç½®é©±åŠ¨æé«˜çµæ´»æ€§
4. âœ… ç‰ˆæœ¬æ§åˆ¶ç¡®ä¿å¯è¿½æº¯
5. âœ… çº¿ç¨‹ç®¡ç†æé«˜æ•ˆç‡

**ç³»ç»Ÿè®¾è®¡åŸåˆ™**ï¼š

```python
design_principles = {
    "åŸåˆ™1": "å•ä¸€èŒè´£ - æ¯ä¸ªæ¨¡å—åªåšä¸€ä»¶äº‹",
    "åŸåˆ™2": "ä½è€¦åˆ - æ¨¡å—é—´ä¾èµ–æœ€å°åŒ–",
    "åŸåˆ™3": "é«˜å†…èš - ç›¸å…³åŠŸèƒ½æ”¾åœ¨ä¸€èµ·",
    "åŸåˆ™4": "é…ç½®é©±åŠ¨ - é€šè¿‡é…ç½®æ§åˆ¶è¡Œä¸º",
    "åŸåˆ™5": "å¯æ‰©å±•æ€§ - æ˜“äºæ·»åŠ æ–°åŠŸèƒ½"
}
```

**ä¸‹ä¸€æ­¥**ï¼šç³»ç»Ÿå»ºå¥½äº†ï¼Œå¦‚ä½•**ç›‘æ§å’Œè¯„ä¼°æ€§èƒ½**å‘¢ï¼Ÿ

[â†’ å‰å¾€ 06-æ€§èƒ½ç›‘æ§ä¸è¯„ä¼°](06-æ€§èƒ½ç›‘æ§ä¸è¯„ä¼°.md)

---

**ğŸ° ç³»ç»Ÿæ¶æ„æ˜¯åŸºç¡€ï¼Œä¸‹èŠ‚è¯¾å­¦ä¹ æ€§èƒ½ç›‘æ§ï¼Œè®©ç³»ç»Ÿè¿è¡Œæ›´é€æ˜ï¼**
